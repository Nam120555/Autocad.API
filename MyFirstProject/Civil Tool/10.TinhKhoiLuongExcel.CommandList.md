# 10. Tính Khối Lượng và Xuất Excel

## Lệnh chính: `CTS_TinhKhoiLuong_Excel`

### Mô tả
Tính khối lượng vật liệu từ Material Section trong Civil 3D và xuất ra file Excel.

### Cách sử dụng
1. Gõ lệnh `CTS_TinhKhoiLuong_Excel` trong AutoCAD
2. **Form chọn Alignment:** Chọn các Alignment có SampleLineGroup cần tính khối lượng
3. **Form sắp xếp vật liệu:** Sắp xếp thứ tự các cột vật liệu trong Excel
4. **SaveFileDialog:** Chọn nơi lưu file Excel

### Công thức tính toán

#### 1. Diện tích đa giác (Shoelace Formula)
```
Area = |Σ(x[i] * y[i+1] - x[i+1] * y[i])| / 2
```

#### 2. Khối lượng (Trung bình cộng × Khoảng cách)
```
Volume[i] = (Area[i-1] + Area[i]) / 2 × Spacing[i]
```

#### 3. Format Station (Lý trình)
```
Km{km}+{meters:F3}  →  Ví dụ: Km0+123.456
```

### Cấu trúc file Excel

#### Sheet chi tiết (1 sheet / Alignment):
| TÊN CỌC | LÝ TRÌNH | KHOẢNG CÁCH | [Vật liệu 1] DT | [Vật liệu 1] KL | ... |
|---------|----------|-------------|-----------------|-----------------|-----|
| Cọc 1   | Km0+000  | 0           | 12.5            | 0               | ... |
| Cọc 2   | Km0+020  | 20          | 15.3            | 278.0           | ... |
| TỔNG CỘNG        |             | SUM()           | SUM()           | ... |

#### Sheet TỔNG HỢP (nếu chọn nhiều Alignment):
- Tổng hợp khối lượng tất cả các đường
- Tham chiếu đến các sheet chi tiết

### Civil 3D API sử dụng
| Object | Method/Property | Mục đích |
|--------|-----------------|----------|
| Alignment | GetSampleLineGroupIds() | Lấy danh sách SampleLineGroup |
| SampleLineGroup | GetSampleLineIds() | Lấy danh sách SampleLine |
| SampleLine | Station, Name | Lấy lý trình và tên cọc |
| SampleLine | GetSectionIds() | Lấy danh sách Section |
| Section | SectionPoints | Danh sách điểm để tính diện tích |

### Ghi chú
- Đảm bảo đã tạo SampleLineGroup và SampleLine trước khi sử dụng
- Các Section được lấy từ SampleLine.GetSectionIds()
- File Excel sử dụng thư viện ClosedXML
