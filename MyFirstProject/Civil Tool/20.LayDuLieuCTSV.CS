using Autodesk.AutoCAD.Geometry;
using Autodesk.AutoCAD.Runtime;
using Autodesk.Civil.DatabaseServices;
using MyFirstProject.Extensions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows.Forms;
using AcadApp = Autodesk.AutoCAD.ApplicationServices.Application;
using AcadColor = Autodesk.AutoCAD.Colors.Color;
using AcadDb = Autodesk.AutoCAD.DatabaseServices;
using ColorMethod = Autodesk.AutoCAD.Colors.ColorMethod;

namespace MyFirstProject
{
    /// <summary>
    /// Lá»‡nh váº½ Ä‘Æ°á»ng bao Material Section trong SectionView
    /// Layer Ä‘Æ°á»£c Ä‘áº·t tÃªn theo Material List
    /// </summary>
    public class LayDuLieuCTSV
    {
        #region Báº£ng mÃ u cho cÃ¡c loáº¡i Material

        /// <summary>
        /// Báº£ng mÃ u cho cÃ¡c loáº¡i Material thÆ°á»ng gáº·p
        /// </summary>
        private static readonly Dictionary<string, short> MaterialColors = new()
        {
            // ÄÃ o - mÃ u nÃ¢u/Ä‘á»
            { "ÄÃ€O", 30 },      // Cam
            { "DAO", 30 },
            { "CUT", 30 },
            
            // Äáº¯p - mÃ u xanh dÆ°Æ¡ng
            { "Äáº®P", 5 },       // Xanh dÆ°Æ¡ng
            { "DAP", 5 },
            { "FILL", 5 },
            
            // Máº·t Ä‘Æ°á»ng - mÃ u xÃ¡m
            { "Máº¶T ÄÆ¯á»œNG", 8 },  // XÃ¡m
            { "MAT DUONG", 8 },
            { "PAVEMENT", 8 },
            
            // MÃ³ng Ä‘Æ°á»ng - mÃ u nÃ¢u
            { "MÃ“NG", 40 },
            { "MONG", 40 },
            { "BASE", 40 },
            
            // BÃª tÃ´ng - mÃ u tráº¯ng
            { "BÃŠ TÃ”NG", 7 },
            { "BE TONG", 7 },
            { "CONCRETE", 7 },
            
            // ÄÃ¡ - mÃ u xÃ¡m Ä‘áº­m
            { "ÄÃ", 251 },
            { "DA", 251 },
            { "ROCK", 251 },
        };

        /// <summary>
        /// MÃ u máº·c Ä‘á»‹nh cho Material khÃ´ng cÃ³ trong báº£ng
        /// </summary>
        private static short DefaultMaterialColor = 3; // Xanh lÃ¡

        #endregion

        #region Lá»‡nh chÃ­nh

        /// <summary>
        /// Lá»‡nh váº½ Ä‘Æ°á»ng bao Material Section trong táº¥t cáº£ SectionView
        /// </summary>
        [CommandMethod("CTSV_VeDuongBaoMaterial")]
        public static void CTSVVeDuongBaoMaterial()
        {
            using AcadDb.Transaction tr = A.Db.TransactionManager.StartTransaction();
            try
            {
                A.Ed.WriteMessage("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
                A.Ed.WriteMessage("\nâ•‘      Váº¼ ÄÆ¯á»œNG BAO MATERIAL SECTION TRONG SECTIONVIEW           â•‘");
                A.Ed.WriteMessage("\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

                // 1. Láº¥y danh sÃ¡ch Alignment cÃ³ SampleLineGroup
                List<AlignmentInfoLocal> alignments = GetAlignmentsWithSampleLineGroups(tr);
                if (alignments.Count == 0)
                {
                    A.Ed.WriteMessage("\nâš ï¸ KhÃ´ng tÃ¬m tháº¥y Alignment cÃ³ SampleLineGroup!");
                    return;
                }

                // 2. Hiá»ƒn thá»‹ form chá»n Alignment
                using FormChonAlignmentLocal formChon = new(alignments);
                if (AcadApp.ShowModalDialog(formChon) != DialogResult.OK)
                {
                    A.Ed.WriteMessage("\nÄÃ£ há»§y lá»‡nh.");
                    return;
                }

                if (formChon.SelectedAlignments.Count == 0)
                {
                    A.Ed.WriteMessage("\nâš ï¸ ChÆ°a chá»n Alignment nÃ o!");
                    return;
                }

                int totalBoundaries = 0;

                // 3. Váº½ Ä‘Æ°á»ng bao cho tá»«ng Alignment Ä‘Æ°á»£c chá»n
                foreach (var alignInfo in formChon.SelectedAlignments)
                {
                    A.Ed.WriteMessage($"\n\nğŸ“ Äang xá»­ lÃ½: {alignInfo.Name}");
                    
                    int count = DrawMaterialBoundariesForAlignment(tr, alignInfo.SampleLineGroupId);
                    totalBoundaries += count;
                    
                    A.Ed.WriteMessage($"\n   âœ… ÄÃ£ váº½ {count} Ä‘Æ°á»ng bao");
                }

                tr.Commit();
                
                A.Ed.WriteMessage($"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                A.Ed.WriteMessage($"\nâœ… HOÃ€N THÃ€NH: ÄÃ£ váº½ tá»•ng cá»™ng {totalBoundaries} Ä‘Æ°á»ng bao Material");
                A.Ed.WriteMessage($"\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
            }
            catch (System.Exception ex)
            {
                A.Ed.WriteMessage($"\nâŒ Lá»—i: {ex.Message}");
                A.Ed.WriteMessage($"\n   Stack: {ex.StackTrace}");
            }
        }

        #endregion

        #region HÃ m váº½ Ä‘Æ°á»ng bao

        /// <summary>
        /// Váº½ Ä‘Æ°á»ng bao Material cho má»™t SampleLineGroup
        /// </summary>
        /// <param name="tr">Transaction hiá»‡n táº¡i</param>
        /// <param name="sampleLineGroupId">ID cá»§a SampleLineGroup</param>
        /// <returns>Sá»‘ lÆ°á»£ng Ä‘Æ°á»ng bao Ä‘Ã£ váº½</returns>
        private static int DrawMaterialBoundariesForAlignment(AcadDb.Transaction tr, AcadDb.ObjectId sampleLineGroupId)
        {
            int totalDrawn = 0;

            try
            {
                // Láº¥y SampleLineGroup
                SampleLineGroup? slg = tr.GetObject(sampleLineGroupId, AcadDb.OpenMode.ForRead) as SampleLineGroup;
                if (slg == null) return 0;

                // Láº¥y ModelSpace Ä‘á»ƒ thÃªm polyline
                AcadDb.BlockTableRecord modelSpace = tr.GetObject(
                    A.Db.CurrentSpaceId, AcadDb.OpenMode.ForWrite) as AcadDb.BlockTableRecord ??
                    throw new System.Exception("KhÃ´ng thá»ƒ má»Ÿ ModelSpace");

                // Láº¥y SectionViewGroup
                SectionViewGroupCollection svgCollection = slg.SectionViewGroups;
                if (svgCollection.Count == 0)
                {
                    A.Ed.WriteMessage("\n   âš ï¸ ChÆ°a cÃ³ SectionViewGroup. HÃ£y táº¡o Section Views trÆ°á»›c.");
                    return 0;
                }

                SectionViewGroup svGroup = svgCollection[0];

                // Láº¥y danh sÃ¡ch Material tá»« Material Lists
                QTOMaterialListCollection materialLists = slg.MaterialLists;
                List<(string MaterialName, string ListName, Guid ListGuid, Guid MaterialGuid)> materialInfo = new();

                foreach (QTOMaterialList materialList in materialLists)
                {
                    try
                    {
                        string listName = materialList.Name;
                        Guid listGuid = materialList.Guid;

                        foreach (QTOMaterial material in materialList)
                        {
                            materialInfo.Add((material.Name, listName, listGuid, material.Guid));
                        }
                    }
                    catch { }
                }

                if (materialInfo.Count == 0)
                {
                    A.Ed.WriteMessage("\n   âš ï¸ KhÃ´ng tÃ¬m tháº¥y Material List nÃ o.");
                    return 0;
                }

                // Táº¡o cÃ¡c layer cho Material (layer = tÃªn Material)
                Dictionary<string, string> materialLayers = new();
                foreach (var (matName, listName, _, _) in materialInfo)
                {
                    if (!materialLayers.ContainsKey(matName))
                    {
                        // Layer = "C3D-MAT-" + tÃªn Material
                        string layerName = $"C3D-MAT-{SanitizeLayerName(matName)}";
                        short colorIndex = GetMaterialColor(matName);
                        CreateLayerIfNotExists(tr, layerName, colorIndex);
                        materialLayers[matName] = layerName;
                    }
                }

                // Láº¥y cÃ¡c SectionView IDs
                AcadDb.ObjectIdCollection sectionViewIds = svGroup.GetSectionViewIds();

                // Duyá»‡t qua tá»«ng SectionView
                foreach (AcadDb.ObjectId svId in sectionViewIds)
                {
                    SectionView? sectionView = tr.GetObject(svId, AcadDb.OpenMode.ForRead) as SectionView;
                    if (sectionView == null) continue;

                    // Láº¥y SampleLine tÆ°Æ¡ng á»©ng
                    AcadDb.ObjectId slId = sectionView.SampleLineId;
                    SampleLine? sampleLine = tr.GetObject(slId, AcadDb.OpenMode.ForRead) as SampleLine;
                    if (sampleLine == null) continue;

                    // Láº¥y vá»‹ trÃ­ SectionView
                    double sectionViewX = sectionView.Location.X;
                    double sectionViewY = sectionView.Location.Y;

                    // Láº¥y ElevationMin Ä‘á»ƒ tÃ­nh offset Y
                    sectionView.UpgradeOpen();
                    sectionView.IsElevationRangeAutomatic = false;
                    double sectionViewElevMin = sectionView.ElevationMin;
                    sectionView.IsElevationRangeAutomatic = true;
                    sectionView.DowngradeOpen();

                    // Váº½ boundary cho má»—i Material
                    foreach (var (matName, listName, listGuid, matGuid) in materialInfo)
                    {
                        try
                        {
                            AcadDb.ObjectId materialSectionId = sampleLine.GetMaterialSectionId(listGuid, matGuid);
                            if (materialSectionId.IsNull || !materialSectionId.IsValid) continue;

                            Section? section = tr.GetObject(materialSectionId, AcadDb.OpenMode.ForRead) as Section;
                            if (section == null) continue;

                            SectionPointCollection sectionPoints = section.SectionPoints;
                            if (sectionPoints.Count < 3) continue;

                            // Táº¡o Polyline tá»« SectionPoints
                            AcadDb.Polyline pline = new();
                            pline.SetDatabaseDefaults();
                            pline.Layer = materialLayers[matName];

                            int vertexIndex = 0;
                            foreach (SectionPoint pt in sectionPoints)
                            {
                                // Chuyá»ƒn Ä‘á»•i tá»a Ä‘á»™ Section sang World
                                // CÃ´ng thá»©c:
                                //   WorldX = SectionView.Location.X + SectionPoint.Offset
                                //   WorldY = SectionView.Location.Y + (SectionPoint.Elevation - ElevationMin)
                                double worldX = sectionViewX + pt.Location.X;
                                double worldY = sectionViewY + (pt.Location.Y - sectionViewElevMin);

                                pline.AddVertexAt(vertexIndex, new Point2d(worldX, worldY), 0, 0, 0);
                                vertexIndex++;
                            }

                            // ÄÃ³ng polyline náº¿u Ä‘iá»ƒm Ä‘áº§u vÃ  cuá»‘i khÃ´ng trÃ¹ng
                            if (sectionPoints.Count >= 3)
                            {
                                Point3d first = sectionPoints[0].Location;
                                Point3d last = sectionPoints[sectionPoints.Count - 1].Location;

                                if (Math.Abs(first.X - last.X) > 0.001 || Math.Abs(first.Y - last.Y) > 0.001)
                                {
                                    pline.Closed = true;
                                }
                            }

                            // ThÃªm polyline vÃ o ModelSpace
                            modelSpace.AppendEntity(pline);
                            tr.AddNewlyCreatedDBObject(pline, true);
                            totalDrawn++;
                        }
                        catch { }
                    }
                }
            }
            catch (System.Exception ex)
            {
                A.Ed.WriteMessage($"\n   âš ï¸ Lá»—i: {ex.Message}");
            }

            return totalDrawn;
        }

        #endregion

        #region HÃ m tiá»‡n Ã­ch

        /// <summary>
        /// Láº¥y mÃ u cho Material dá»±a trÃªn tÃªn
        /// </summary>
        private static short GetMaterialColor(string materialName)
        {
            string upperName = materialName.ToUpperInvariant();

            foreach (var kvp in MaterialColors)
            {
                if (upperName.Contains(kvp.Key))
                {
                    return kvp.Value;
                }
            }

            return DefaultMaterialColor;
        }

        /// <summary>
        /// Chuáº©n hÃ³a tÃªn layer (loáº¡i bá» kÃ½ tá»± khÃ´ng há»£p lá»‡)
        /// </summary>
        private static string SanitizeLayerName(string name)
        {
            // CÃ¡c kÃ½ tá»± khÃ´ng há»£p lá»‡ trong tÃªn layer AutoCAD
            char[] invalidChars = { '<', '>', '/', '\\', '"', ':', ';', '?', '*', '|', ',', '=', '`' };

            string result = name;
            foreach (char c in invalidChars)
            {
                result = result.Replace(c, '_');
            }

            // Giá»›i háº¡n Ä‘á»™ dÃ i tÃªn layer
            if (result.Length > 200)
            {
                result = result.Substring(0, 200);
            }

            return result;
        }

        /// <summary>
        /// Táº¡o layer náº¿u chÆ°a tá»“n táº¡i
        /// </summary>
        private static void CreateLayerIfNotExists(AcadDb.Transaction tr, string layerName, short colorIndex)
        {
            AcadDb.LayerTable? lt = tr.GetObject(A.Db.LayerTableId, AcadDb.OpenMode.ForRead) as AcadDb.LayerTable;
            if (lt == null) return;

            if (!lt.Has(layerName))
            {
                lt.UpgradeOpen();
                AcadDb.LayerTableRecord ltr = new()
                {
                    Name = layerName,
                    Color = AcadColor.FromColorIndex(ColorMethod.ByAci, colorIndex)
                };
                lt.Add(ltr);
                tr.AddNewlyCreatedDBObject(ltr, true);
            }
        }

        /// <summary>
        /// Láº¥y danh sÃ¡ch Alignment cÃ³ SampleLineGroup
        /// </summary>
        private static List<AlignmentInfoLocal> GetAlignmentsWithSampleLineGroups(AcadDb.Transaction tr)
        {
            List<AlignmentInfoLocal> result = new();

            try
            {
                AcadDb.ObjectIdCollection alignmentIds = A.Cdoc.GetAlignmentIds();

                foreach (AcadDb.ObjectId alignId in alignmentIds)
                {
                    try
                    {
                        Alignment? alignment = tr.GetObject(alignId, AcadDb.OpenMode.ForRead) as Alignment;
                        if (alignment == null) continue;

                        AcadDb.ObjectIdCollection slgIds = alignment.GetSampleLineGroupIds();
                        if (slgIds.Count == 0) continue;

                        foreach (AcadDb.ObjectId slgId in slgIds)
                        {
                            SampleLineGroup? slg = tr.GetObject(slgId, AcadDb.OpenMode.ForRead) as SampleLineGroup;
                            if (slg == null) continue;

                            result.Add(new AlignmentInfoLocal
                            {
                                Name = $"{alignment.Name} - {slg.Name}",
                                AlignmentId = alignId,
                                SampleLineGroupId = slgId
                            });
                        }
                    }
                    catch { }
                }
            }
            catch { }

            return result;
        }

        #endregion

        #region Data Classes

        /// <summary>
        /// ThÃ´ng tin Alignment (local class Ä‘á»ƒ trÃ¡nh phá»¥ thuá»™c)
        /// </summary>
        private class AlignmentInfoLocal
        {
            public AcadDb.ObjectId AlignmentId { get; set; }
            public string Name { get; set; } = "";
            public AcadDb.ObjectId SampleLineGroupId { get; set; }
            public bool IsSelected { get; set; }
        }

        /// <summary>
        /// Form chá»n Alignment Ä‘Æ¡n giáº£n
        /// </summary>
        private class FormChonAlignmentLocal : Form
        {
            private CheckedListBox checkedListBox;
            private Button btnOK;
            private Button btnCancel;
            private List<AlignmentInfoLocal> alignmentInfos;

            public List<AlignmentInfoLocal> SelectedAlignments => 
                alignmentInfos.Where(a => a.IsSelected).ToList();

            public FormChonAlignmentLocal(List<AlignmentInfoLocal> alignments)
            {
                alignmentInfos = alignments;
                InitializeComponent();
                LoadData();
            }

            private void InitializeComponent()
            {
                Text = "Chá»n Alignment Ä‘á»ƒ váº½ Ä‘Æ°á»ng bao";
                Width = 450;
                Height = 350;
                StartPosition = FormStartPosition.CenterScreen;
                FormBorderStyle = FormBorderStyle.FixedDialog;
                MaximizeBox = false;

                checkedListBox = new CheckedListBox
                {
                    Location = new System.Drawing.Point(12, 12),
                    Width = 410,
                    Height = 250,
                    CheckOnClick = true
                };
                checkedListBox.ItemCheck += (s, e) =>
                {
                    int index = e.Index;
                    alignmentInfos[index].IsSelected = e.NewValue == CheckState.Checked;
                };

                btnOK = new Button
                {
                    Text = "OK",
                    DialogResult = DialogResult.OK,
                    Location = new System.Drawing.Point(266, 270),
                    Width = 75
                };

                btnCancel = new Button
                {
                    Text = "Há»§y",
                    DialogResult = DialogResult.Cancel,
                    Location = new System.Drawing.Point(347, 270),
                    Width = 75
                };

                Controls.Add(checkedListBox);
                Controls.Add(btnOK);
                Controls.Add(btnCancel);

                AcceptButton = btnOK;
                CancelButton = btnCancel;
            }

            private void LoadData()
            {
                checkedListBox.Items.Clear();
                foreach (var info in alignmentInfos)
                {
                    int idx = checkedListBox.Items.Add(info.Name);
                    checkedListBox.SetItemChecked(idx, true);
                    info.IsSelected = true;
                }
            }
        }

        #endregion
    }
}

